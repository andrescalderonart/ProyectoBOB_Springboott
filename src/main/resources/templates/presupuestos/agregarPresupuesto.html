<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Crear Nuevo Presupuesto</title> <!-- Static title since we only create -->

    <style>
        /* Style for material rows (same as before) */
        .material-row {
            margin: 10px 0;
            padding: 5px;
            border: 1px solid #ddd;
        }

        /* Form styling */
        input, select, button {
            margin: 5px 0;
            display: block;
        }

        .btn-remove {
            color: red;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn {
            padding: 8px 16px;
            background-color: #4CAF50; /* Green */
            color: white;
            border: none;
            cursor: pointer;
        }

        /* Blue "add" button */
        .btn-add {
            background-color: #2196F3;
        }
    </style>
</head>
<body>
<h1>Crear Nuevo Presupuesto</h1>

<!-- Back button -->
<a th:href="@{/presupuestos/inicioPresupuestos}" class="btn">Regresar</a>
<br><br>

<!-- Create Form (now the only form) -->
<form th:action="@{/presupuestos/salvar}" method="post" th:object="${presupuesto}">

    <!-- Work Name Input -->
    <div>
        <label><b>Nombre de la obra:</b></label>
        <input type="text" th:field="*{obraName}" required>
    </div>

    <h3>Actividades:</h3>

    <!-- Single dropdown for selection -->
    <div>
        <select id="activityDropdown">
            <option value="">Seleccione...</option>
            <option th:each="mat : ${matriz}"
                    th:value="${mat.id_m}"
                    th:data-nombre="${mat.nombre}"
                    th:data-unidades="${mat.unidades}"
                    th:text="${mat.nombre} + ' (' + mat.unidades + ')'">
            </option>
        </select>

        <input type="number" id="activityQuantity" step="0.01" min="0.01"
               placeholder="Cantidad" class="quantity-input">

        <button type="button" onclick="addactivity()" class="btn btn-add">
            Añadir actividad
        </button>
    </div>

    <!-- Container for selected  -->
    <div id="selectedActivities">
        <!-- Selected activities will appear here -->
    </div>

    <!-- Hidden inputs that will be submitted -->
    <div id="hiddenInputs"></div>

    <!-- Submit Button -->
    <button type="submit" class="btn">Guardar presupuesto</button>
</form>

<script>
    // Store added activities to prevent duplicates
    const addedActivities = new Set();

    function addActivity() {
        const dropdown = document.getElementById('activityDropdown');
        const quantityInput = document.getElementById('activityQuantity');
        const selectedActivitiesDiv = document.getElementById('selectedActivities');
        const hiddenInputsDiv = document.getElementById('hiddenInputs');

        const selectedOption = dropdown.options[dropdown.selectedIndex];
        const activityId = selectedOption.value;
        const activityName = selectedOption.getAttribute('data-nombre');
        const activityUnits = selectedOption.getAttribute('data-unidades');
        const quantity = quantityInput.value;

        // Validate selection
        if (!activityId) {
            alert("Por favor seleccione una actividad");
            return;
        }

        if (!quantity || parseFloat(quantity) <= 0) {
            alert("Por favor ingrese una cantidad válida");
            return;
        }

        // Check if activity already added
        if (addedActivities.has(activityId)) {
            alert("Esta actividad ya fue agregada");
            return;
        }

        // Add to set
        addedActivities.add(activityId);

        // Create visible display
        const activityDiv = document.createElement('div');
        activityDiv.className = 'selected-activity';
        activityDiv.innerHTML = `
            <span>${activityName} (${activityUnits}) - Cantidad: ${quantity}</span>
            <span class="btn-remove" onclick="removeActivity('${activityId}', this)">✕ Eliminar</span>
        `;
        selectedActivitiesDiv.appendChild(activityDiv);

        // Create hidden inputs for form submission
        const materialIdInput = document.createElement('input');
        materialIdInput.type = 'hidden';
        materialIdInput.name = 'activityIds';
        materialIdInput.value = activityId;

        const quantityInputHidden = document.createElement('input');
        quantityInputHidden.type = 'hidden';
        quantityInputHidden.name = 'quantities';
        quantityInputHidden.value = quantity;

        hiddenInputsDiv.appendChild(activityIdInput);
        hiddenInputsDiv.appendChild(quantityInputHidden);

        // Reset inputs
        dropdown.selectedIndex = 0;
        quantityInput.value = '';
    }

    function removeActivity(activityId, element) {
        // Remove from set
        addedActivities.delete(activityId);

        // Remove visual element
        element.parentElement.remove();

        // Remove corresponding hidden inputs
        const hiddenInputs = document.querySelectorAll('#hiddenInputs input');
        for (let i = 0; i < hiddenInputs.length; i++) {
            if (hiddenInputs[i].name === 'activityIds' && hiddenInputs[i].value === activityId) {
                hiddenInputs[i].remove();
                hiddenInputs[i+1].remove(); // Remove the corresponding quantity input
                break;
            }
        }
    }
</script>
</body>
</html>