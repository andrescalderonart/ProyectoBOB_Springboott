<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Crear Nuevo Presupuesto</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/CSS/agregarPresu.css}">
</head>
<body>
<div class="container">
    <!-- Encabezado -->
    <div class="header">
        <h1 class="page-title">Crear Nuevo Presupuesto</h1>
    </div>

    <!-- Botón de regreso -->
    <a th:href="@{/presupuestos/inicioPresupuestos}" class="back-btn">← Regresar</a>

    <!-- Formulario -->
    <form th:action="@{/presupuestos/salvar}" method="post" th:object="${presupuesto}">

        <!-- Nombre de la obra -->
        <div class="form-group">
            <label for="obraName"><b>Nombre de la obra:</b></label>
            <input type="text" id="obraName" th:field="*{obraName}" class="form-input" required>
        </div>

        <!-- Sección de actividades -->
        <div class="activities-section">
            <h3 class="section-title">Actividades:</h3>

            <div class="activity-selector">
                <div class="selector-row">
                    <div class="select-container">
                        <label for="activityDropdown">Seleccionar actividad:</label>
                        <select id="activityDropdown" class="form-select">
                            <option value="">Seleccione...</option>
                            <option th:each="mat : ${matriz}"
                                    th:value="${mat.id_m}"
                                    th:data-nombre="${mat.nombre}"
                                    th:data-unidades="${mat.unidades}"
                                    th:text="${mat.nombre} + ' (' + mat.unidades + ')'">
                            </option>
                        </select>
                    </div>

                    <div class="quantity-container">
                        <label for="activityQuantity">Cantidad:</label>
                        <input type="number" id="activityQuantity" step="0.01" min="0.01"
                               placeholder="Cantidad" class="form-input quantity-input">
                    </div>

                    <div class="add-btn-container">
                        <button type="button" onclick="addActivity()" class="btn btn-add">
                            + Añadir actividad
                        </button>
                    </div>
                </div>
            </div>

            <div class="selected-activities-container">
                <h4 class="selected-title">Actividades seleccionadas:</h4>
                <div id="selectedActivities" class="selected-activities"></div>
            </div>
        </div>

        <!-- Inputs ocultos para enviar las actividades -->
        <div id="hiddenInputs"></div>

        <div class="submit-container">
            <button type="submit" class="btn btn-submit">Guardar presupuesto</button>
        </div>
    </form>
</div>

<!-- JavaScript -->
<script>
    const addedActivities = new Set();

    function addActivity() {
        const dropdown = document.getElementById('activityDropdown');
        const quantityInput = document.getElementById('activityQuantity');
        const selectedActivitiesDiv = document.getElementById('selectedActivities');
        const hiddenInputsDiv = document.getElementById('hiddenInputs');

        const selectedOption = dropdown.options[dropdown.selectedIndex];
        const activityId = selectedOption.value;
        const activityName = selectedOption.getAttribute('data-nombre');
        const activityUnits = selectedOption.getAttribute('data-unidades');
        const quantity = quantityInput.value;

        if (!activityId) {
            alert("Por favor seleccione una actividad");
            return;
        }

        if (!quantity || parseFloat(quantity) <= 0) {
            alert("Por favor ingrese una cantidad válida");
            return;
        }

        if (addedActivities.has(activityId)) {
            alert("Esta actividad ya fue agregada");
            return;
        }

        addedActivities.add(activityId);

        const activityDiv = document.createElement('div');
        activityDiv.className = 'selected-activity';
        activityDiv.innerHTML = `
            <div class="activity-info">
                <span class="activity-name">${activityName}</span>
                <span class="activity-units">(${activityUnits})</span>
                <span class="activity-quantity">Cantidad: ${quantity}</span>
            </div>
            <button type="button" class="btn-remove" onclick="removeActivity('${activityId}', this)">
                ✕ Eliminar
            </button>
        `;
        selectedActivitiesDiv.appendChild(activityDiv);

        // Crear inputs ocultos
        const actividadIdInput = document.createElement('input');
        actividadIdInput.type = 'hidden';
        actividadIdInput.name = 'actividadIds';
        actividadIdInput.value = activityId;

        const cantidadInputHidden = document.createElement('input');
        cantidadInputHidden.type = 'hidden';
        cantidadInputHidden.name = 'cantidades';
        cantidadInputHidden.value = quantity;

        hiddenInputsDiv.appendChild(actividadIdInput);
        hiddenInputsDiv.appendChild(cantidadInputHidden);

        // Reset campos
        dropdown.selectedIndex = 0;
        quantityInput.value = '';
    }

    function removeActivity(activityId, element) {
        addedActivities.delete(activityId);
        element.parentElement.remove();

        const hiddenInputs = document.querySelectorAll('#hiddenInputs input');
        for (let i = 0; i < hiddenInputs.length; i++) {
            if (hiddenInputs[i].name === 'actividadIds' && hiddenInputs[i].value === activityId) {
                hiddenInputs[i].remove();
                hiddenInputs[i + 1].remove(); // El input siguiente es el de cantidad
                break;
            }
        }
    }
</script>
</body>
</html>
